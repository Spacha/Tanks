<html>
<script>
var connected = false;
function join()
{
	console.log("Loaded")
	const socket = new WebSocket('ws://localhost:8765');

	window.socket = socket;
	window.count = 0;

	let room = document.querySelector('input[name="room"]').value;
	let player_name = document.querySelector('input[name="name"]').value;

	socket.addEventListener('open', function (event) {
		socket.send(encode_msg([null,
		{
			type: 'join',
			room: room,
			player_name: player_name
		}]));
		console.log("Opened")
	});

	//window.count = 0;
	socket.addEventListener('message', function (event) {
		//console.log('Message from server ', event.data);
		window.count++;
	});
	
	window.addEventListener('beforeunload', () => {
		console.log("UNLOAD")
		socket.close()
	})
	console.log("LOADED")
	connected = true;
	
	setInterval(() => {
		console.log("Ticks per second: " + count);
		document.querySelector('span[id="ticks-per-second"]').innerHTML = count;
		window.count = 0;
	}, 1000)
	/*
	let count = 0;
	setInterval(() => {
		count = count+1
		socket.send(encode_msg({
			type: 'ping',
			seq: count,
		}))
	}, 500)
	*/
}

function disconnect() { 
	socket.close();
	connected = false;
	// TODO: remove event listeners
}

function encode_msg(msg) { 
	return JSON.stringify(msg)
}

function decode_msg(text) {
	return JSON.parse(text)
}

</script>
<!--<body onload="loaded()">-->
<body>
	<h2>Join room:</h2>

	<div>
		<span>Room name:</span>
		<input name="room" />
	</div>
	<div>
		<span>Nickname:</span>
		<input name="name" />
	</div>

	<button onclick="join()">Join!</button>
	<button onclick="disconnect()">Disconnect</button>

	<div>
		<p>Stats:</p>
		<p>Ticks last second: <span id=ticks-per-second></span></p>
	</div>
</body>
</html>
